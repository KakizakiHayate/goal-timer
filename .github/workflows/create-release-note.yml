name: Create GitHub Release with all PRs since last tag

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    if: startsWith(github.event.head_commit.message, 'Merge pull request')

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest_tag
        run: |
          git fetch --tags
          TAG=$(git describe --tags --abbrev=0 || echo "")
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Extract version from release branch
        id: get_version
        run: |
          BRANCH=$(git log -1 --merges --pretty=format:"%s" | grep -oE 'release/[0-9]+\.[0-9]+\.[0-9]+' || true)
          if [[ -z "$BRANCH" ]]; then
            echo "::error::release/x.x.x ãƒ–ãƒ©ãƒ³ãƒåãŒãƒžãƒ¼ã‚¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          VERSION=${BRANCH#release/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create new tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag v${{ steps.get_version.outputs.version }}
          git push origin v${{ steps.get_version.outputs.version }}

      - name: Generate changelog from PRs since last tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ãƒªãƒªãƒ¼ã‚¹å†…å®¹ï¼ˆv${{ steps.get_version.outputs.version }}ï¼‰" > changelog.md

          # å‰å›žã®ã‚¿ã‚°ã‹ã‚‰HEADã¾ã§ã®Merge PRã‚’å–å¾—
          COMMITS=$(git log ${{ steps.latest_tag.outputs.tag }}..HEAD --merges --pretty=format:"%s")
          
          # ãƒ‡ãƒãƒƒã‚°: ã‚³ãƒŸãƒƒãƒˆä¸€è¦§ã‚’è¡¨ç¤º
          echo "ðŸ“‹ Found commits between ${{ steps.latest_tag.outputs.tag }} and HEAD:"
          git log ${{ steps.latest_tag.outputs.tag }}..HEAD --merges --pretty=format:"%h %s"
          
          # ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼åˆæœŸåŒ–
          PR_COUNT=0
          TICKET_COUNT=0
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜ã—ã¦è¡Œã”ã¨ã«å‡¦ç†ï¼ˆåŽ³å¯†ãªãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã§ï¼‰
          git log ${{ steps.latest_tag.outputs.tag }}..HEAD --merges --pretty=format:"%s" > commits.txt
          echo "ðŸ“ Raw commit messages from git:"
          cat commits.txt
          
          while IFS= read -r commit_msg; do
            echo "ðŸ”„ Processing commit message: '$commit_msg'"
            
            # PRç•ªå·ã‚’è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è©¦è¡Œ
            if [[ "$commit_msg" =~ [Mm]erge\ pull\ request\ \#([0-9]+) ]]; then
              PR_NUM=${BASH_REMATCH[1]}
              echo "âœ… Pattern 1 matched! Found PR #$PR_NUM"
            elif [[ "$commit_msg" =~ \#([0-9]+) ]]; then
              PR_NUM=${BASH_REMATCH[1]}
              echo "âœ… Pattern 2 matched! Found PR #$PR_NUM"
            else
              echo "âŒ No PR pattern matched in commit message"
              continue
            fi
            
            echo "ðŸ” Processing PR #$PR_NUM"
            PR_COUNT=$((PR_COUNT + 1))
            
            # PRã®æƒ…å ±ã‚’è©³ç´°ã«å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ ï¼‰
            if ! gh pr view $PR_NUM --json title,body,number &> pr_info.json; then
              echo "âš ï¸ Failed to get PR #$PR_NUM info, skipping"
              continue
            fi
            
            cat pr_info.json
            PR_JSON=$(cat pr_info.json)
            TITLE=$(echo "$PR_JSON" | jq -r '.title')
            BODY=$(echo "$PR_JSON" | jq -r '.body')
            
            # PRæƒ…å ±ãŒnullã®å ´åˆã¯å¯¾å¿œ
            if [[ "$TITLE" == "null" || -z "$TITLE" ]]; then
              echo "âš ï¸ PR #$PR_NUM title is null or empty, skipping"
              continue
            fi
            
            # è©³ç´°ãªãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
            echo "::debug::PR #$PR_NUM Title: $TITLE"
            echo "::debug::PR Body length: $(echo "$BODY" | wc -c) chars"
            echo "::notice::PR #$PR_NUM Body first 100 chars: $(echo "$BODY" | head -c 100)..."
            
            CHANGELOG_ENTRY_ADDED=false
            
            # ä¸€åº¦PRã®BODYå…¨ä½“ã§ç›´æŽ¥Backlogãƒã‚±ãƒƒãƒˆãƒªãƒ³ã‚¯ã‚’æ¤œç´¢
            if echo "$BODY" | grep -q "\[TANZAM_MHT-[0-9]\+\]"; then
              echo "âœ“ Backlog ticket references found in PR body!"
              
              # ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒªãƒ³ã‚¯å½¢å¼ã‚’æŠ½å‡º
              MARKDOWN_LINKS=$(echo "$BODY" | grep -o "\[TANZAM_MHT-[0-9]\+\](https://[^)]*)" || echo "")
              
              if [[ -n "$MARKDOWN_LINKS" ]]; then
                echo "ðŸŽ¯ Found markdown links: $MARKDOWN_LINKS"
                echo "$MARKDOWN_LINKS" > markdown_links.txt
                
                # å„ãƒªãƒ³ã‚¯ã‚’å‡¦ç†
                while IFS= read -r link; do
                  # ãƒã‚±ãƒƒãƒˆç•ªå·ã‚’æŠ½å‡º
                  TICKET=$(echo "$link" | grep -o "TANZAM_MHT-[0-9]\+")
                  
                  # URL ã‚’æŠ½å‡º
                  URL=$(echo "$link" | grep -o "(.*)" | sed 's/(\(.*\))/\1/')
                  
                  # ãã®è¡Œã®æ¦‚è¦ã‚’æŽ¢ã™
                  LINE=$(echo "$BODY" | grep "$link")
                  SUMMARY=$(echo "$LINE" | sed -E "s/.*\]\\($URL\\)[[:space:]]*(.*)/\\1/" || echo "$TITLE")
                  
                  echo "ðŸ’¡ Extracted: Ticket=$TICKET, URL=$URL, Summary=$SUMMARY"
                  echo "- [$TICKET]($URL) $SUMMARY" >> changelog.md
                  CHANGELOG_ENTRY_ADDED=true
                  TICKET_COUNT=$((TICKET_COUNT + 1))
                done < markdown_links.txt
              fi
            else
              echo "âŒ No Backlog ticket references found in PR body using direct search"
            fi
            
            # ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒªãƒ³ã‚¯å½¢å¼ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€è¡Œã”ã¨ã«å‡¦ç†
            if [ "$CHANGELOG_ENTRY_ADDED" = false ]; then
              echo "--- Start processing BODY line by line ---"
              echo "$BODY" > pr_body.txt
              
              while IFS= read -r line; do
                echo "Processing line: [$line]"
                # ã‚ˆã‚Šæ­£ç¢ºãªãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒªãƒ³ã‚¯æ¤œå‡º
                if [[ "$line" =~ \[TANZAM_MHT-[0-9]+\]\(https://[^)]+\) ]]; then
                  echo "  -> Markdown link found in line"
                  
                  # ãƒã‚±ãƒƒãƒˆç•ªå·ã‚’æŠ½å‡º
                  TICKET=$(echo "$line" | grep -o 'TANZAM_MHT-[0-9]\+')
                  
                  # URL ã‚’æŠ½å‡º
                  URL=$(echo "$line" | grep -o '(https://[^)]*)' | sed 's/(\(.*\))/\1/')
                  
                  # æ¦‚è¦ã‚’æŠ½å‡º - ãƒªãƒ³ã‚¯ã®å¾Œã®éƒ¨åˆ†
                  SUMMARY=$(echo "$line" | sed -E 's/\[.*\]\([^)]+\)[[:space:]]*(.*)/\1/')
                  
                  echo "  -> Found Ticket: [$TICKET]($URL): $SUMMARY" # ãƒ­ã‚°å‡ºåŠ›
                  echo "- [$TICKET]($URL) $SUMMARY" >> changelog.md
                  CHANGELOG_ENTRY_ADDED=true
                  TICKET_COUNT=$((TICKET_COUNT + 1))
                else
                  echo "  -> No markdown link in this line"
                fi
              done < pr_body.txt
              echo "--- End processing BODY line by line ---"
            fi
            
            echo "::notice::CHANGELOG_ENTRY_ADDED=$CHANGELOG_ENTRY_ADDED"
            
            # ãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦PRã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
            if [ "$CHANGELOG_ENTRY_ADDED" = false ]; then
              echo "  -> No Ticket found in body, using PR title." # ãƒ­ã‚°å‡ºåŠ›
              echo "- (PR #$PR_NUM): $TITLE" >> changelog.md
            fi
          done < commits.txt
          
          # çµ±è¨ˆæƒ…å ±
          echo "ðŸ“Š Found $PR_COUNT PRs and $TICKET_COUNT tickets"
          echo "ðŸ“„ Changelog content:"
          cat changelog.md

      - name: Create GitHub Release
        run: |
          gh release create v${{ steps.get_version.outputs.version }} \
            --title "v${{ steps.get_version.outputs.version }}" \
            --notes-file changelog.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 