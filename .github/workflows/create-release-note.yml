name: Create GitHub Release with all PRs since last tag

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: startsWith(github.event.head_commit.message, 'Merge pull request')

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest_tag
        run: |
          git fetch --tags
          TAG=$(git describe --tags --abbrev=0 || echo "")
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Extract version from release branch
        id: get_version
        run: |
          BRANCH=$(git log -1 --merges --pretty=format:"%s" | grep -oE 'release/[0-9]+\.[0-9]+\.[0-9]+' || true)
          if [[ -z "$BRANCH" ]]; then
            echo "::error::release/x.x.x ãƒ–ãƒ©ãƒ³ãƒåãŒãƒžãƒ¼ã‚¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          VERSION=${BRANCH#release/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create new tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag v${{ steps.get_version.outputs.version }}
          git push origin v${{ steps.get_version.outputs.version }}

      - name: Generate changelog from PRs since last tag
        run: |
          echo "## ãƒªãƒªãƒ¼ã‚¹å†…å®¹ï¼ˆv${{ steps.get_version.outputs.version }}ï¼‰" > changelog.md

          # å‰å›žã®ã‚¿ã‚°ã‹ã‚‰HEADã¾ã§ã®Merge PRã‚’å–å¾—
          COMMITS=$(git log ${{ steps.latest_tag.outputs.tag }}..HEAD --merges --pretty=format:"%s")
          
          for commit in $COMMITS; do
            if [[ "$commit" =~ Merge\ pull\ request\ \#([0-9]+) ]]; then
              PR_NUM=${BASH_REMATCH[1]}
              echo "ðŸ” Processing PR #$PR_NUM"
              PR_JSON=$(gh pr view $PR_NUM --json title,body)
              TITLE=$(echo "$PR_JSON" | jq -r '.title')
              BODY=$(echo "$PR_JSON" | jq -r '.body')

              CHANGELOG_ENTRY_ADDED=false
              # BODY ã‚’1è¡Œãšã¤å‡¦ç†ã—ã¦ã€Markdown ãƒªãƒ³ã‚¯å½¢å¼ã® Backlog ãƒã‚±ãƒƒãƒˆã‚’æŽ¢ã™
              echo "--- Start processing BODY ---"
              echo "$BODY" | while IFS= read -r line; do
                echo "Processing line: [$line]"
                # æ­£è¦è¡¨ç¾: [TANZAM_MHT-XXX](URL) æ¦‚è¦
                regex='\[(TANZAM_MHT-[0-9]+)\]\(([^)]+)\)\s+(.*)'
                if [[ "$line" =~ $regex ]]; then
                  echo "  -> Regex MATCHED"
                  TICKET="${BASH_REMATCH[1]}"
                  URL="${BASH_REMATCH[2]}"
                  SUMMARY="${BASH_REMATCH[3]}"
                  # æ¦‚è¦ã®å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
                  SUMMARY=$(echo "$SUMMARY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                  
                  echo "  -> Found Ticket: [$TICKET]($URL): $SUMMARY" # ãƒ­ã‚°å‡ºåŠ›
                  echo "- [$TICKET]($URL): $SUMMARY" >> changelog.md
                  CHANGELOG_ENTRY_ADDED=true
                else
                  echo "  -> Regex NOT MATCHED"
                fi
              done
              echo "--- End processing BODY ---"
              
              # ãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦PRã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
              if [ "$CHANGELOG_ENTRY_ADDED" = false ]; then
                echo "  -> No Ticket found in body, using PR title." # ãƒ­ã‚°å‡ºåŠ›
                echo "- (PR #$PR_NUM): $TITLE" >> changelog.md
              fi
            fi
          done

      - name: Create GitHub Release
        run: |
          gh release create v${{ steps.get_version.outputs.version }} \
            --title "v${{ steps.get_version.outputs.version }}" \
            --notes-file changelog.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 