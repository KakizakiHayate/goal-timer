# 学習記録画面（統計詳細画面）要件

## 1. 機能概要

### 目的
ホーム画面のストリークカード「詳細を見る」から遷移し、月間の学習状況を可視化する。

### 解決する課題
- 直近7日間だけでなく、月単位で学習状況を確認したい
- 過去の学習記録を振り返りたい

---

## 2. 機能要件

### 2.1 画面構成

```
┌─────────────────────────────────────┐
│ ←  学習記録                         │
├─────────────────────────────────────┤
│                                     │
│  🔥 5日連続学習中！  最長: 12日      │
│                                     │
│  ◀  2024年12月  ▶                   │
│                                     │
│  月  火  水  木  金  土  日          │
│                                     │
│              1                      │
│             ▪️                       │
│                                     │
│   2   3   4   5   6   7   8         │
│  🟩  🟩  ▪️  🟩  🟩  🟩  🟩          │
│                                     │
│   9  10  11  12  13  14  15         │
│  🟩  ▪️  🟩  🟩  🟩  🟩  🟩          │
│                                     │
│  16  17  18  19  20  21  22         │
│  🟩  🟩  ▪️  ▪️  🟩  🟩  🟩          │
│                                     │
│  23  24  25  26  27  28  29         │
│  🟩  🟩  🟩  🟩  ○  ▪️  ▪️           │
│                   ↑今日              │
│  30  31                             │
│  ▪️  ▪️                              │
│                                     │
└─────────────────────────────────────┘
```

### 2.2 ストリーク表示

| 要素 | 表示形式 |
|------|----------|
| 現在のストリーク | 「🔥 {N}日連続学習中！」 |
| 最長ストリーク | 「最長: {N}日」 |
| レイアウト | 横並び |

### 2.3 月間カレンダー

| 項目 | 仕様 |
|------|------|
| 週の開始曜日 | **月曜日** |
| 月切り替え | ◀ ▶ ボタン（スワイプなし） |
| 過去の範囲 | 最初の学習記録がある月まで |
| 未来の範囲 | 今月まで（翌月は見れない） |

### 2.4 カレンダーの色分け

| 状態 | 表示 | 色 |
|------|------|-----|
| 過去の日・学習あり（1分以上） | 🟩 緑のマス | `ColorConsts.success` (#10B981) |
| 過去の日・学習なし | ▪️ グレーのマス | `ColorConsts.disabled` (#E5E7EB) |
| 今日・学習あり | 🟩 緑のマス | `ColorConsts.success` (#10B981) |
| 今日・学習なし | ○ 青枠線のみ | `ColorConsts.primary` (#3B82F6) 枠線 |

### 2.5 日付タップ時のボトムシート

**学習記録がある日をタップした場合：**

```
┌─────────────────────────────────────┐
│  12月23日（月）の学習記録            │
├─────────────────────────────────────┤
│                                     │
│  📚 英語学習              45分      │
│  💻 プログラミング         30分      │
│  📖 削除された目標         15分      │
│                                     │
│  ─────────────────────────          │
│  合計                 1時間30分      │
│                                     │
└─────────────────────────────────────┘
```

| 項目 | 仕様 |
|------|------|
| 学習記録なしの日 | タップしても何も表示しない |
| 同じ目標で複数回学習 | 合算して1行表示 |
| 削除された目標 | 「削除された目標」と表示 |
| 閉じる方法 | 下スワイプ + 背景タップ |

### 2.6 学習記録がない場合

| 状態 | 表示 |
|------|------|
| 学習記録が一切ない | 今月のみ表示（全グレー） |
| 月切り替え | ◀ ボタン非活性（今月のみ表示可能） |

---

## 3. データ仕様

### 3.1 既存テーブルの変更

#### goalsテーブル

**追加カラム：**
| カラム | 型 | 用途 |
|--------|-----|------|
| `deleted_at` | TEXT (nullable) | 論理削除日時（ISO8601形式） |

**削除処理の変更：**
- 物理削除 → 論理削除に変更
- 削除時に`deleted_at`に現在日時を設定
- ホーム画面では`deleted_at IS NULL`の目標のみ表示

#### usersテーブル

**追加カラム：**
| カラム | 型 | 用途 |
|--------|-----|------|
| `longest_streak` | INTEGER | 最長連続学習日数（デフォルト: 0） |

**更新タイミング：**
- タイマー完了時に現在のストリークと比較
- 現在のストリーク > longest_streak の場合に更新

### 3.2 使用テーブル

| テーブル | 用途 |
|----------|------|
| `study_daily_logs` | 月間カレンダーの学習日取得、日別学習記録取得 |
| `goals` | 目標名の表示（deleted_atで削除判定） |
| `users` | 最長ストリーク取得・更新 |

### 3.3 必要なクエリ

```sql
-- 指定月の学習日リスト取得
SELECT DATE(study_date) as study_day
FROM study_daily_logs
WHERE DATE(study_date) >= ? AND DATE(study_date) <= ?
GROUP BY DATE(study_date)
HAVING SUM(total_seconds) >= 60;

-- 指定日の目標別学習時間取得
SELECT goal_id, SUM(total_seconds) as total
FROM study_daily_logs
WHERE DATE(study_date) = ?
GROUP BY goal_id;

-- 最初の学習記録日を取得
SELECT MIN(DATE(study_date)) as first_date
FROM study_daily_logs;

-- 最長ストリーク取得
SELECT longest_streak FROM users LIMIT 1;
```

---

## 4. UI詳細仕様

### 4.1 画面全体

| 項目 | 値 | 定数 |
|------|-----|------|
| 画面タイトル | 「学習記録」 | - |
| 背景色 | `#F8F9FA` | `ColorConsts.backgroundPrimary` |
| 戻るボタン | ← | 標準のAppBar |

### 4.2 ストリーク表示セクション

| 項目 | 値 | 定数 |
|------|-----|------|
| 🔥アイコン | `#F59E0B` | `ColorConsts.warning` |
| テキスト | 18px, SemiBold | `TextConsts.bodyLarge` + `FontWeight.w600` |
| 「最長:」テキスト | 14px, Regular | `TextConsts.bodySmall` |
| 背景 | カード形式 | `ColorConsts.cardBackground` |
| パディング | 16px | `SpacingConsts.md` |

### 4.3 月切り替えセクション

| 項目 | 値 |
|------|-----|
| ◀ ▶ ボタン | IconButton |
| 月表示 | 「2024年12月」形式、18px, SemiBold |
| ボタン無効時 | opacity 0.3 |

### 4.4 カレンダー

| 項目 | 値 |
|------|-----|
| 曜日ヘッダー | 月 火 水 木 金 土 日 |
| 曜日テキスト | 14px, Medium, グレー |
| 日付テキスト | 16px, Regular |
| マスサイズ | 40px × 40px |
| マス間隔 | 4px |
| 角丸 | 8px |

### 4.5 ボトムシート

| 項目 | 値 | 定数 |
|------|-----|------|
| ヘッダー | 「{月}月{日}日（{曜日}）の学習記録」 | - |
| ヘッダーテキスト | 18px, SemiBold | `TextConsts.bodyLarge` |
| 目標アイコン | 📚 💻 📖 など（目標のアイコン） | - |
| 目標名 | 16px, Regular | `TextConsts.bodyMedium` |
| 時間 | 16px, SemiBold, 右寄せ | - |
| 区切り線 | 1px, グレー | `ColorConsts.disabled` |
| 合計テキスト | 18px, SemiBold | - |
| 最大高さ | 画面の50% | - |
| 角丸（上部） | 20px | - |

---

## 5. ファイル構成

### 5.1 新規作成ファイル

| ファイルパス | 説明 |
|-------------|------|
| `lib/features/statistics/view/statistics_screen.dart` | 学習記録画面 |
| `lib/features/statistics/view_model/statistics_view_model.dart` | ViewModel |
| `lib/features/statistics/view/widgets/monthly_calendar.dart` | 月間カレンダーウィジェット |
| `lib/features/statistics/view/widgets/daily_record_bottom_sheet.dart` | 日別記録ボトムシート |
| `test/features/statistics/view_model/statistics_view_model_test.dart` | ViewModelのテスト |
| `test/features/statistics/view/widgets/monthly_calendar_test.dart` | カレンダーのテスト |

### 5.2 修正ファイル

| ファイルパス | 修正内容 |
|-------------|----------|
| `lib/core/data/local/app_database.dart` | goalsにdeleted_at、usersにlongest_streak追加 |
| `lib/core/data/local/local_goals_datasource.dart` | 論理削除に変更、deleted_at考慮 |
| `lib/core/data/local/local_study_daily_logs_datasource.dart` | 月間データ取得、日別記録取得メソッド追加 |
| `lib/core/data/local/local_users_datasource.dart` | 最長ストリーク取得・更新メソッド追加 |
| `lib/core/models/goals/goals_model.dart` | deleted_atフィールド追加 |
| `lib/features/home/view_model/home_view_model.dart` | 論理削除対応（deleted_at IS NULLでフィルタ） |
| `lib/features/timer/view_model/timer_view_model.dart` | タイマー完了時に最長ストリーク更新 |
| `lib/core/widgets/streak_card.dart` | onTapで統計画面へ遷移 |

---

## 6. 画面遷移

```
ホーム画面
    │
    │ ストリークカード「詳細を見る」タップ
    ▼
学習記録画面
    │
    │ 日付タップ（学習記録あり）
    ▼
ボトムシート表示
    │
    │ 下スワイプ or 背景タップ
    ▼
ボトムシート閉じる
    │
    │ ← 戻るボタン
    ▼
ホーム画面
```

---

## 7. エラーハンドリング

| エラー | 対応 |
|--------|------|
| DBクエリ失敗 | AppLoggerでエラーログ、空データで表示継続 |
| 最長ストリーク更新失敗 | ログのみ、ユーザーに通知しない |

---

## 8. テストケース

### 8.1 ViewModelテスト

| テストケース | 期待値 |
|-------------|--------|
| 月間学習日の取得 | 正しい日付リストが返る |
| 月切り替え（過去） | 学習記録がある月まで遷移可能 |
| 月切り替え（未来） | 今月より先には遷移不可 |
| 日別学習記録取得 | 目標ごとに合算された時間が返る |
| 削除された目標の表示 | 「削除された目標」として返る |
| 最長ストリーク取得 | DBから正しい値が返る |

### 8.2 ウィジェットテスト

| テストケース | 期待値 |
|-------------|--------|
| カレンダー表示（月曜始まり） | 月曜が左端に表示 |
| 学習日の色分け | 1分以上の日が緑色 |
| 今日の表示（学習あり） | 緑色で表示 |
| 今日の表示（学習なし） | 青枠線で表示 |
| 日付タップ（学習あり） | ボトムシート表示 |
| 日付タップ（学習なし） | 何も表示されない |
| ボトムシート閉じる | 下スワイプで閉じる |

---

## 9. 開発フロー

### 9.1 TDD（テスト駆動開発）で実装

```
1. テストコードを先に書く
   ↓
2. テストが失敗することを確認（Red）
   ↓
3. テストが通る最小限の実装を行う（Green）
   ↓
4. リファクタリング（Refactor）
   ↓
5. 次のテストへ
```

### 9.2 要件が曖昧な場合

**テストコードを書いていて、要件が曖昧・不明確な箇所があった場合は、実装を進めずに必ず質問すること。自己判断で実装を進めないこと。**

### 9.3 実装順序

| 順番 | 作業 | 詳細 |
|------|------|------|
| 1 | ブランチ作成 | `git checkout -b feat/statistics-screen` |
| 2 | DBマイグレーション | goals.deleted_at, users.longest_streak追加 |
| 3 | DataSourceテスト作成 | 新規メソッドのテスト |
| 4 | DataSource実装 | テストが通るように実装 |
| 5 | 論理削除対応 | goals削除処理の変更 |
| 6 | ViewModelテスト作成 | 統計画面のViewModel |
| 7 | ViewModel実装 | テストが通るように実装 |
| 8 | ウィジェットテスト作成 | カレンダー、ボトムシート |
| 9 | ウィジェット実装 | テストが通るように実装 |
| 10 | 画面遷移実装 | ストリークカードからの遷移 |
| 11 | 最長ストリーク更新 | タイマー完了時の処理 |
| 12 | 全テスト実行 | `flutter test` |
| 13 | ビルド確認 | 下記コマンド実行 |
| 14 | PR作成 | 全て成功後にPR作成 |

### 9.4 PR作成前の必須チェック

```bash
# 1. 静的解析
flutter analyze

# 2. 全テスト実行
flutter test

# 3. iOSビルド
flutter build ipa --debug

# 4. Androidビルド
flutter build apk --debug
```

**全て成功しない場合はPRを作成しないこと。**

---

## 10. 受け入れ条件

### 機能要件
- [ ] ホーム画面のストリークカード「詳細を見る」から遷移できる
- [ ] 月間カレンダーが月曜始まりで表示される
- [ ] 学習日が緑色、未学習日がグレーで表示される
- [ ] 今日が正しくマークされる（学習あり=緑、なし=青枠線）
- [ ] ◀ ▶ で月切り替えができる
- [ ] 過去は最初の学習記録がある月まで遡れる
- [ ] 未来は今月までしか見れない
- [ ] 学習日をタップするとボトムシートが表示される
- [ ] ボトムシートに目標別の学習時間が表示される
- [ ] 同じ目標で複数回学習した場合は合算表示される
- [ ] 削除された目標は「削除された目標」と表示される
- [ ] 学習記録がない日はタップしても何も表示されない
- [ ] 現在のストリークと最長ストリークが横並びで表示される
- [ ] タイマー完了時に最長ストリークが更新される

### DB変更要件
- [ ] goalsテーブルにdeleted_atカラムが追加されている
- [ ] usersテーブルにlongest_streakカラムが追加されている
- [ ] 目標削除が論理削除に変更されている
- [ ] ホーム画面でdeleted_atがnullの目標のみ表示される

### 品質要件
- [ ] `flutter analyze` でエラーなし
- [ ] `flutter test` で全テストパス
- [ ] `flutter build ipa --debug` でビルド成功
- [ ] `flutter build apk --debug` でビルド成功

### テスト要件
- [ ] DataSourceのユニットテストが存在し、全てパス
- [ ] ViewModelのユニットテストが存在し、全てパス
- [ ] ウィジェットのユニットテストが存在し、全てパス
- [ ] テストはTDDで先に書かれていること
